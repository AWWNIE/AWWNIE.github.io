<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Watch Together</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; }
    #queue { max-width: 400px; margin: 10px; }
    #queue div { margin: 5px 0; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Watch Together</h1>
  <input id="name" placeholder="Your name" />
  <input id="room" placeholder="Room ID" />
  <button id="join">Join Room</button>
  <br/><br/>
  <input id="video" placeholder="YouTube video ID" />
  <input id="title" placeholder="Video title" />
  <button id="add">Add to Queue</button>

  <h3>Queue</h3>
  <div id="queue"></div>

  <div id="player"></div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let socket, player;
    let currentVideo = null;

    const queueDiv = document.getElementById("queue");

    document.getElementById("join").onclick = () => {
      const name = document.getElementById("name").value;
      const room = document.getElementById("room").value;
      if (!name || !room) return alert("Enter name and room ID");

      socket = io("awwniegithubio-production.up.railway.app"); // <-- replace with backend URL
      socket.emit("joinRoom", { roomId: room, name });

      socket.on("queueUpdated", renderQueue);
      socket.on("currentVideo", loadVideo);
      socket.on("playVideo", () => player?.playVideo());
      socket.on("pauseVideo", () => player?.pauseVideo());
    };

    document.getElementById("add").onclick = () => {
      const videoId = document.getElementById("video").value;
      const title = document.getElementById("title").value;
      if (!videoId) return;
      socket.emit("addToQueue", { videoId, title });
    };

    function renderQueue(queue) {
      queueDiv.innerHTML = "";
      queue.forEach((v, i) => {
        const div = document.createElement("div");
        div.textContent = v.title || v.videoId;
        div.onclick = () => socket.emit("nextFromQueue");
        queueDiv.appendChild(div);
      });
    }

    function loadVideo(video) {
      currentVideo = video;
      if (!video) return;
      if (!player) {
        window.onYouTubeIframeAPIReady = () => {
          player = new YT.Player("player", {
            height: "390", width: "640",
            videoId: video.videoId,
            events: {
              'onStateChange': onPlayerStateChange
            }
          });
        };
      } else {
        player.loadVideoById(video.videoId);
      }
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        socket.emit("nextFromQueue");
      }
    }
  </script>
</body>
</html>
