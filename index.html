<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Watch Together</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #queue { margin-top: 10px; }
    #videoContainer { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Watch Together</h1>
  <div>
    Name: <input type="text" id="nameInput"><br><br>
    Room ID: <input type="text" id="roomInput">
    <button id="joinBtn">Join Room</button>
  </div>

  <div id="app" style="display:none;">
    <input type="text" id="videoInput" placeholder="YouTube video URL or ID">
    <button id="addVideoBtn">Add Video</button>

    <h3>Queue:</h3>
    <ul id="queue"></ul>

    <div id="videoContainer"></div>
  </div>

  <script>
    let socket;
    let player;
    let currentRoom = "";

    function extractVideoID(url) {
      const match = url.match(/[?&]v=([^&]+)/);
      if (match && match[1]) return match[1];
      const shortMatch = url.match(/youtu\.be\/([^?&]+)/);
      if (shortMatch && shortMatch[1]) return shortMatch[1];
      return url;
    }

    document.getElementById("joinBtn").onclick = () => {
      const name = document.getElementById("nameInput").value;
      const room = document.getElementById("roomInput").value;
      if (!name || !room) return alert("Enter name and room ID");

      currentRoom = room;
      document.getElementById("app").style.display = "block";

      socket = io("https://awwniegithubio-production.up.railway.app/"); // Replace with Railway URL
      socket.emit("joinRoom", room, name);

      socket.on("updateQueue", (queue) => {
        const ul = document.getElementById("queue");
        ul.innerHTML = "";
        queue.forEach(v => {
          const li = document.createElement("li");
          li.textContent = v;
          ul.appendChild(li);
        });
      });

      socket.on("playVideo", (videoId) => {
        if (player) player.loadVideoById(videoId);
        else createPlayer(videoId);
      });
    };

    document.getElementById("addVideoBtn").onclick = () => {
      const url = document.getElementById("videoInput").value.trim();
      if (!url) return;
      const videoId = extractVideoID(url);
      socket.emit("addVideo", { roomId: currentRoom, videoId });
      document.getElementById("videoInput").value = "";
    };

    function createPlayer(videoId) {
      player = new YT.Player('videoContainer', {
        height: '390',
        width: '640',
        videoId: videoId,
        events: { 'onStateChange': onPlayerStateChange }
      });
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        socket.emit("videoEnded", currentRoom);
      }
    }
  </script>
</body>
</html>
